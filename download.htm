<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eurimobility SA | Strategic Command Center</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js & Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .btn-primary { background: #2563EB; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background 0.3s; }
        .btn-primary:hover { background: #1d4ed8; }
        .slider { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #d1d5db; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #2563EB; cursor: pointer; }
        .kpi-value { font-size: 2.5rem; font-weight: 800; color: #111827; }
        .kpi-label { font-size: 0.875rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        
        /* Custom Toggles */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
<script defer data-domain="project-eurimobility.tiiny.site" src="https://analytics.tiiny.site/js/plausible.js"></script><script type="text/javascript" src="https://tiiny.host/ad-script.js"></script></head>
<body class="text-slate-800">

    <!-- HEADER -->
    <nav class="bg-slate-900 text-white p-6 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fa-solid fa-layer-group fa-lg"></i></div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">EURIMOBILITY SA</h1>
                    <p class="text-xs text-slate-400 font-medium tracking-wide">STRATEGIC PROCUREMENT DASHBOARD • VISION 2026</p>
                </div>
            </div>
            <div class="hidden md:flex gap-6 text-sm font-medium text-slate-300">
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div> Live Simulation Mode</div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 space-y-8">

        <!-- SECTION 1: KPI COCKPIT -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Revenue -->
            <div class="card border-l-4 border-slate-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">Total Spend</p>
                        <p class="kpi-value">€312M</p>
                    </div>
                    <div class="bg-slate-100 p-2 rounded text-slate-600"><i class="fa-solid fa-wallet"></i></div>
                </div>
                <div class="mt-4 text-xs text-slate-500 font-medium">60% of Revenue</div>
            </div>

            <!-- Asian Dependency (Dynamic) -->
            <div class="card border-l-4 border-red-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">Asian Dependency</p>
                        <p class="kpi-value text-red-600" id="kpi-asia">63%</p>
                    </div>
                    <div class="bg-red-50 p-2 rounded text-red-600"><i class="fa-solid fa-earth-asia"></i></div>
                </div>
                <div class="mt-4 w-full bg-gray-200 rounded-full h-2.5">
                    <div id="bar-asia" class="bg-red-600 h-2.5 rounded-full transition-all duration-1000" style="width: 63%"></div>
                </div>
                <div class="mt-2 flex justify-between text-xs font-bold">
                    <span class="text-red-600">Current: 63%</span>
                    <span class="text-green-600">Target: < 40%</span>
                </div>
            </div>

            <!-- European Share (Dynamic) -->
            <div class="card border-l-4 border-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">European Share</p>
                        <p class="kpi-value text-green-600" id="kpi-eu">27%</p>
                    </div>
                    <div class="bg-green-50 p-2 rounded text-green-600"><i class="fa-solid fa-industry"></i></div>
                </div>
                <div class="mt-4 w-full bg-gray-200 rounded-full h-2.5">
                    <div id="bar-eu" class="bg-green-600 h-2.5 rounded-full transition-all duration-1000" style="width: 27%"></div>
                </div>
                <div class="mt-2 flex justify-between text-xs font-bold">
                    <span class="text-slate-500">Current: 27%</span>
                    <span class="text-green-600">Target: > 50%</span>
                </div>
            </div>

            <!-- Financial Risk (Dynamic) -->
            <div class="card border-l-4 border-orange-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="kpi-label">Scenario Risk Exposure</p>
                        <p class="kpi-value text-orange-600" id="kpi-risk">€0.0M</p>
                    </div>
                    <div class="bg-orange-50 p-2 rounded text-orange-600"><i class="fa-solid fa-triangle-exclamation"></i></div>
                </div>
                <div class="mt-4 text-xs text-slate-500 font-medium" id="risk-desc">Baseline: No active scenarios</div>
            </div>
        </section>

        <!-- SECTION 2: STRATEGY SIMULATOR (Smart Cap) -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Controls -->
            <div class="card bg-slate-800 text-white lg:col-span-1 flex flex-col justify-center space-y-6">
                <div>
                    <h3 class="text-xl font-bold mb-2 text-white"><i class="fa-solid fa-chess-knight mr-2"></i>Strategy C: Smart Cap</h3>
                    <p class="text-slate-400 text-sm">Activate the reallocation of €18.4M battery spend from Asia to Europe using the Top 5 Leverage Suppliers.</p>
                </div>
                
                <div class="p-4 bg-slate-700 rounded-lg border border-slate-600">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold text-slate-300">Implementation Status</span>
                        <span id="strategy-status" class="text-xs bg-red-500 px-2 py-1 rounded text-white font-bold">INACTIVE</span>
                    </div>
                    <button onclick="toggleStrategy()" id="btn-strategy" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-rocket"></i> EXECUTE STRATEGY
                    </button>
                </div>

                <div class="space-y-2 text-xs text-slate-400">
                    <div class="flex justify-between"><span class="font-bold">Target Move:</span> <span>€18,400,000</span></div>
                    <div class="flex justify-between"><span class="font-bold">Suppliers Used:</span> <span>5 (LFP, EcoVolt, Energion)</span></div>
                    <div class="flex justify-between"><span class="font-bold">Max Growth Cap:</span> <span>50%</span></div>
                </div>
            </div>

            <!-- Spend Chart -->
            <div class="card lg:col-span-2">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Market Share Projection (Batteries)</h3>
                <div class="chart-container">
                    <canvas id="marketShareChart"></canvas>
                </div>
            </div>
        </section>

        <!-- SECTION 2.5: COMMODITY PRICE INTELLIGENCE (AI FORECAST) -->
        <section class="card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
                <div>
                    <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-chart-line text-blue-500 mr-2"></i>Commodity Price Intelligence</h3>
                    <p class="text-sm text-slate-500">AI-Powered Linear Regression Forecast (2024-2026)</p>
                </div>
                <div class="bg-blue-50 px-3 py-1 rounded text-xs font-bold text-blue-700">
                    <i class="fa-solid fa-robot mr-1"></i> Model: Regression
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Forecast Chart -->
                <div class="lg:col-span-3">
                    <div class="chart-container">
                        <canvas id="priceForecastChart"></canvas>
                    </div>
                </div>
                
                <!-- Insights Sidebar -->
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 lg:col-span-1 flex flex-col justify-center space-y-4">
                    <div>
                        <span class="text-xs font-bold text-slate-400 uppercase">Lithium Trend</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-2xl font-bold text-blue-600">↗ Rising</span>
                            <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded font-bold">Alert</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">Projected to break Index 220 by mid-2026.</p>
                    </div>
                    
                    <div>
                        <span class="text-xs font-bold text-slate-400 uppercase">Copper Trend</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-2xl font-bold text-orange-600">→ Stable</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">Low volatility forecasted. Spot buying safe.</p>
                    </div>

                    <div class="border-t pt-4 mt-2">
                        <span class="text-xs font-bold text-slate-800 uppercase">Strategic Action</span>
                        <p class="text-sm text-slate-600 mt-1 font-medium">
                            <i class="fa-solid fa-lock text-green-600 mr-1"></i> Hedge Lithium Now
                        </p>
                        <p class="text-xs text-slate-500">Lock in 2026 contracts at current rates (Index ~180) to avoid Q1 spikes (>220).</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: SCENARIO STRESS TEST -->
        <section class="card">
            <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4">
                <div>
                    <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-bolt text-yellow-500 mr-2"></i>Dynamic Stress Test</h3>
                    <p class="text-sm text-slate-500">Simulate geopolitical and logistical shocks to calculate financial impact.</p>
                </div>
                <div class="mt-2 md:mt-0 text-right">
                    <div class="text-sm font-bold text-slate-400">Projected Annual Cost</div>
                    <div class="text-3xl font-bold text-slate-800" id="total-sim-cost">€312.0M</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Controls -->
                <div class="space-y-6">
                    <!-- S1 -->
                    <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                        <div class="flex items-center justify-between mb-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="check-s1" class="w-4 h-4 text-red-600 rounded focus:ring-red-500" onchange="updateSimulation()">
                                <span class="ml-2 font-bold text-red-900">S1: Chip Shortage</span>
                            </label>
                            <span class="text-xs bg-white px-2 py-1 rounded border text-red-600 font-bold" id="val-s1">12%</span>
                        </div>
                        <input type="range" id="slider-s1" min="0" max="30" value="12" class="slider" oninput="updateSimulation()">
                        <p class="text-xs text-red-700 mt-2">Impact: Electronics Price Hike</p>
                    </div>

                    <!-- S2 -->
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                        <div class="flex items-center justify-between mb-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="check-s2" class="w-4 h-4 text-orange-600 rounded focus:ring-orange-500" onchange="updateSimulation()">
                                <span class="ml-2 font-bold text-orange-900">S2: Trade War</span>
                            </label>
                            <span class="text-xs bg-white px-2 py-1 rounded border text-orange-600 font-bold" id="val-s2">10%</span>
                        </div>
                        <input type="range" id="slider-s2" min="0" max="50" value="10" class="slider" oninput="updateSimulation()">
                        <p class="text-xs text-orange-700 mt-2">Impact: Tariffs on Chinese Imports</p>
                    </div>

                    <!-- S3 -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <div class="flex items-center justify-between mb-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="check-s3" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" onchange="updateSimulation()">
                                <span class="ml-2 font-bold text-blue-900">S3: Logistics Crisis</span>
                            </label>
                            <span class="text-xs bg-white px-2 py-1 rounded border text-blue-600 font-bold" id="val-s3">5%</span>
                        </div>
                        <input type="range" id="slider-s3" min="0" max="20" value="5" class="slider" oninput="updateSimulation()">
                        <p class="text-xs text-blue-700 mt-2">Impact: Freight Cost (Asia)</p>
                    </div>
                </div>

                <!-- Simulation Charts (Tabbed view or Stacked + Line) -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 1. Cost Breakdown (Stacked Bar) -->
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="scenarioChart"></canvas>
                    </div>
                    
                    <!-- 2. Cost Escalation Ladder (Line Graph) -->
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="escalationChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 4: AI SUPPLIER SEGMENTATION (Clustering) -->
        <section class="card">
            <div class="mb-6 border-b pb-4">
                <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-brain text-purple-600 mr-2"></i>AI Supplier Segmentation</h3>
                <p class="text-sm text-slate-500">Unsupervised Learning (K-Means) identifying "Hidden Risk" by correlating Regional Origin with Performance.</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Chart Area -->
                <div class="lg:col-span-3">
                    <div class="chart-container" style="height: 500px;">
                        <canvas id="clusteringChart"></canvas>
                    </div>
                </div>

                <!-- Legend & Insight Sidebar -->
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 lg:col-span-1 space-y-6">
                    <div>
                        <h4 class="font-bold text-purple-900 text-sm uppercase mb-2">Legend: Clusters</h4>
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div> <span class="text-xs text-slate-700">Cluster 0: High Risk (Low ESG/Qual)</span>
                        </div>
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div> <span class="text-xs text-slate-700">Cluster 1: Safe Zone (High Perf)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-yellow-500"></div> <span class="text-xs text-slate-700">Cluster 2: Average</span>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-purple-900 text-sm uppercase mb-2">Legend: Geography</h4>
                        <div class="flex items-center gap-2 mb-1">
                            <i class="fa-solid fa-xmark text-slate-500"></i> <span class="text-xs text-slate-700">Asian Supplier (Cross)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-circle text-slate-500"></i> <span class="text-xs text-slate-700">European Supplier (Circle)</span>
                        </div>
                    </div>

                    <div class="bg-white p-3 rounded border border-purple-100">
                        <h4 class="font-bold text-red-600 text-sm mb-1"><i class="fa-solid fa-triangle-exclamation"></i> AI Insight</h4>
                        <p class="text-xs text-slate-600 leading-relaxed">
                            The algorithm has detected a strong correlation: The <strong>"Risk Cluster" (Red)</strong> is populated almost entirely by suppliers marked with <strong>Crosses (Asia)</strong>. 
                            <br><br>
                            This confirms that our structural risk is geographic, not random.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 5: KRALJIC MATRIX -->
        <section class="card">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Portfolio Segmentation (Kraljic Matrix)</h3>
            <div class="chart-container" style="height: 500px;">
                <canvas id="kraljicChart"></canvas>
            </div>
        </section>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-sm">© 2025 Eurimobility SA | Master 2 e-Procurement Case Study</p>
            <p class="text-xs mt-2">Data powered by Live Simulation Engine</p>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA CONSTANTS ---
        const BASELINE_SPEND = 312000000;
        const ELEC_SPEND = 105000000;
        const BATTERY_SPEND = 80000000;
        
        // Asian Spend approximations for simulation
        const ASIA_SPEND_TOTAL = 196000000; // ~63%
        const CHINA_SPEND = 150000000; // Est. subset of Asia

        // Chart Instances
        let marketChart;
        let scenarioChart;
        let escalationChart;
        let kraljicChart;
        let priceChart;
        let clusteringChart;

        // --- REAL DATA INJECTION FROM CSV (Parsed as JSON) ---
        // Replacing the dummy data points with the actual suppliers provided in Detailed_suppliers.csv
        // Calculated fields: Kraljic X (Risk), Kraljic Y (Log Spend)
        const supplierData = [
            // STRATEGIC (High Risk, High Spend) - The Problem
            { label: 'Foxtron (CN)', x: 90, y: 7.94, r: 15, region: 'Asia', cluster: 0, category: 'Electronics' }, // €87M
            { label: 'Foxtron 2 (CN)', x: 88, y: 7.75, r: 12, region: 'Asia', cluster: 0, category: 'Electronics' }, // €55M
            { label: 'Panasonic Energy (JP)', x: 50, y: 7.56, r: 10, region: 'Asia', cluster: 2, category: 'Batteries' }, // €36M
            { label: 'Panasonic 38 (JP)', x: 90, y: 6.51, r: 7, region: 'Asia', cluster: 0, category: 'Batteries' }, // €3.2M
            { label: 'BYE Power 30 (CN)', x: 90, y: 6.37, r: 6, region: 'Asia', cluster: 0, category: 'Batteries' }, // €2.3M

            // LEVERAGE (Low Risk, High Spend) - The Solution (Batteries)
            { label: 'LFP Europe 39 (FR)', x: 30, y: 6.96, r: 10, region: 'Europe', cluster: 1, category: 'Batteries' }, // €9.1M
            { label: 'EcoVolt 15 (PT)', x: 25, y: 6.80, r: 9, region: 'Europe', cluster: 1, category: 'Batteries' }, // €6.3M
            { label: 'EcoVolt 13 (PT)', x: 28, y: 6.74, r: 9, region: 'Europe', cluster: 1, category: 'Batteries' }, // €5.5M
            { label: 'EcoVolt 32 (PT)', x: 20, y: 6.61, r: 8, region: 'Europe', cluster: 1, category: 'Batteries' }, // €4.1M
            { label: 'Energion Slovakia 37', x: 35, y: 6.43, r: 7, region: 'Europe', cluster: 1, category: 'Batteries' }, // €2.7M
            { label: 'LFP Europe 33 (FR)', x: 45, y: 6.41, r: 7, region: 'Europe', cluster: 1, category: 'Batteries' }, // €2.6M
            { label: 'LFP Europe 6 (FR)', x: 15, y: 6.23, r: 7, region: 'Europe', cluster: 1, category: 'Batteries' }, // €1.7M

            // LEVERAGE (Low Risk, High Spend) - Other Categories
            { label: 'Nexans (FR)', x: 20, y: 7.62, r: 11, region: 'Europe', cluster: 1, category: 'Wiring' }, // €42M approx
            { label: 'Moldovia SRL 22 (RO)', x: 30, y: 6.96, r: 10, region: 'Europe', cluster: 1, category: 'Plastics' }, // €9.1M
            { label: 'EcoForm 10 (FR)', x: 35, y: 6.73, r: 9, region: 'Europe', cluster: 1, category: 'Plastics' }, // €5.3M
            { label: 'Informatica Polska 11', x: 45, y: 6.72, r: 9, region: 'Europe', cluster: 2, category: 'Indirect' }, // €5.2M

            // BOTTLENECK (High Risk, Low Spend)
            { label: 'LingTech 5 (VN)', x: 90, y: 5.50, r: 5, region: 'Asia', cluster: 0, category: 'Electronics' }, // €314k
            { label: 'LingTech 6 (VN)', x: 80, y: 5.50, r: 5, region: 'Asia', cluster: 0, category: 'Electronics' }, // €314k
            { label: 'Foxtron 7 (CN)', x: 85, y: 5.04, r: 4, region: 'Asia', cluster: 0, category: 'Electronics' }, // €111k
            
            // NON-CRITICAL (Low Risk, Low Spend)
            { label: 'MicroData 8 (FR)', x: 25, y: 6.57, r: 7, region: 'Europe', cluster: 1, category: 'Electronics' }, // €3.7M
            { label: 'Velec Polska 3 (PL)', x: 10, y: 6.39, r: 6, region: 'Europe', cluster: 1, category: 'Electronics' }, // €2.4M
        ];

        // --- 1. INITIALIZE CHARTS ---
        window.onload = function() {
            initMarketChart();
            initPriceChart();
            initScenarioChart();
            initEscalationChart();
            initClusteringChart();
            initKraljicChart();
            // Trigger initial update to set lines correctly based on default sliders
            updateSimulation();
        };

        function initMarketChart() {
            const ctx = document.getElementById('marketShareChart').getContext('2d');
            marketChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Asia (Risk)', 'Europe (Sovereignty)', 'Other'],
                    datasets: [{
                        data: [63, 27, 10],
                        backgroundColor: ['#EF4444', '#10B981', '#94A3B8'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: 'Current Geographic Share (%)' }
                    },
                    cutout: '60%'
                }
            });
        }

        function initPriceChart() {
            const ctx = document.getElementById('priceForecastChart').getContext('2d');
            
            // Real Data from Material_prices.csv + Python Linear Regression Forecast
            const labels = [
                'Q1 24', 'Q2 24', 'Q3 24', 'Q4 24', 
                'Q1 25', 'Q2 25', 'Q3 25', 'Q4 25', 
                'Q1 26 (F)', 'Q2 26 (F)'
            ];
            
            // Lithium: Rising Trend (Actuals + AI Forecast)
            const lithiumData = [110, 134, 151, 156, 180, 210, 209, 197, 215, 230];
            // Copper: Stable Trend (Actuals + AI Forecast)
            const copperData = [107, 103, 115, 108, 113, 113, 110, 108, 109, 110];

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Lithium Index (AI Forecast)',
                            data: lithiumData,
                            borderColor: '#2563EB', // Blue
                            backgroundColor: '#2563EB',
                            borderWidth: 3,
                            tension: 0.3,
                            segment: {
                                borderDash: ctx => ctx.p0DataIndex >= 7 ? [6, 6] : undefined, // Dash the forecast part
                            }
                        },
                        {
                            label: 'Copper Index (AI Forecast)',
                            data: copperData,
                            borderColor: '#F97316', // Orange
                            backgroundColor: '#F97316',
                            borderWidth: 3,
                            tension: 0.3,
                            segment: {
                                borderDash: ctx => ctx.p0DataIndex >= 7 ? [6, 6] : undefined, // Dash the forecast part
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Price Index (Base 100)' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y;
                                    }
                                    if (context.dataIndex >= 8) {
                                        label += ' (Proj)';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function initScenarioChart() {
            const ctx = document.getElementById('scenarioChart').getContext('2d');
            scenarioChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Baseline Spend', 'Simulated Spend'],
                    datasets: [
                        { label: 'Base Cost', data: [312, 312], backgroundColor: '#94A3B8', stack: 'Stack 0' },
                        { label: 'S1 Risk (Price)', data: [0, 0], backgroundColor: '#EF4444', stack: 'Stack 0' },
                        { label: 'S2 Risk (Tariff)', data: [0, 0], backgroundColor: '#F97316', stack: 'Stack 0' },
                        { label: 'S3 Risk (Logistics)', data: [0, 0], backgroundColor: '#3B82F6', stack: 'Stack 0' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false, min: 250, title: { display: true, text: 'Spend Breakdown (€M)' } } },
                    plugins: { tooltip: { mode: 'index', intersect: false } }
                }
            });
        }

        function initEscalationChart() {
            const ctx = document.getElementById('escalationChart').getContext('2d');
            escalationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Baseline', 'Logistics (S3)', 'Trade War (S2)', 'Shortage (S1)', 'Perfect Storm'],
                    datasets: [{
                        label: 'Projected Total Cost',
                        data: [312, 312, 312, 312, 312], // Initial placeholders
                        borderColor: '#2563EB',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: ['#94A3B8', '#3B82F6', '#F97316', '#EF4444', '#DC2626'],
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false, min: 300, title: { display: true, text: 'Total Escalation (€M)' } } },
                    plugins: {
                        title: { display: true, text: 'Cost Escalation Ladder (Impact Comparison)' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '€' + context.parsed.y.toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function initClusteringChart() {
            const ctx = document.getElementById('clusteringChart').getContext('2d');
            
            // Map the supplierData to the Cluster Chart format
            // X=RSE (from dataset), Y=Quality (from dataset) - we simulate these as they are not in the simplified array above
            // We use the 'cluster' attribute from the supplierData
            
            // Enriched data for clustering visualization based on the cluster assignment
            const clusterData = supplierData.map(s => {
                // Reconstruct approximate scores based on cluster logic if not explicit
                // Cluster 0 (Risk): Low RSE (<75), Low Quality
                // Cluster 1 (Safe): High RSE (>85), High Quality
                let rse = 50, qual = 60;
                if (s.cluster === 1) { rse = 85 + Math.random()*10; qual = 85 + Math.random()*10; }
                else if (s.cluster === 0) { rse = 50 + Math.random()*20; qual = 60 + Math.random()*15; }
                else { rse = 75 + Math.random()*10; qual = 75 + Math.random()*10; }
                
                return {
                    x: rse, 
                    y: qual,
                    r: s.r,
                    region: s.region,
                    cluster: s.cluster,
                    label: s.label
                };
            });

            clusteringChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Suppliers',
                        data: clusterData,
                        backgroundColor: (ctx) => {
                            const c = ctx.raw?.cluster;
                            if (c === 0) return '#EF4444'; // Red (Risk)
                            if (c === 1) return '#10B981'; // Green (Safe)
                            return '#F59E0B'; // Yellow (Avg)
                        },
                        pointStyle: (ctx) => {
                            const r = ctx.raw?.region;
                            return r === 'Asia' ? 'crossRot' : 'circle';
                        },
                        borderWidth: 2,
                        borderColor: (ctx) => {
                             const r = ctx.raw?.region;
                             return r === 'Asia' ? '#EF4444' : '#10B981'; 
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: 40, max: 100, title: { display: true, text: 'Ethical Score (RSE)' } },
                        y: { min: 50, max: 100, title: { display: true, text: 'Quality Score' } }
                    },
                    plugins: {
                        title: { display: true, text: 'AI Segmentation: Clusters vs. Geography' },
                        annotation: {
                            annotations: {
                                box1: {
                                    type: 'box',
                                    xMin: 40, xMax: 75,
                                    yMin: 50, yMax: 80,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 1,
                                    label: {
                                        content: 'DIVESTMENT ZONE',
                                        enabled: true,
                                        position: 'center',
                                        color: 'red',
                                        font: { weight: 'bold' }
                                    }
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const r = context.raw.region;
                                    return `${context.raw.label} (${r})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function initKraljicChart() {
            const ctx = document.getElementById('kraljicChart').getContext('2d');
            
            // Use the real supplierData array directly
            kraljicChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Suppliers',
                        data: supplierData,
                        backgroundColor: (ctx) => {
                            const x = ctx.raw?.x;
                            const y = ctx.raw?.y;
                            // Approximate quadrants based on median values from analysis (Risk ~50, Spend Log ~6.5)
                            if (x > 50 && y > 6.5) return '#EF4444'; // Strategic (Red)
                            if (x <= 50 && y > 6.5) return '#10B981'; // Leverage (Green) - Target Zone
                            if (x > 50 && y <= 6.5) return '#F59E0B'; // Bottleneck (Orange)
                            return '#94A3B8'; // Non-Critical
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 100, title: { display: true, text: 'Supply Risk (High →)' }, grid: { drawBorder: false } },
                        y: { min: 4, max: 9, title: { display: true, text: 'Profit Impact (Log Spend)' }, grid: { drawBorder: false } }
                    },
                    plugins: {
                        title: { display: true, text: 'Supplier Portfolio Map (Actual Candidates)' },
                        annotation: {
                            annotations: {
                                line1: { type: 'line', yMin: 6.5, yMax: 6.5, borderColor: 'grey', borderWidth: 1, borderDash: [5, 5], label: { content: 'Avg Spend', enabled: true } },
                                line2: { type: 'line', xMin: 50, xMax: 50, borderColor: 'grey', borderWidth: 1, borderDash: [5, 5], label: { content: 'Avg Risk', enabled: true } },
                                // Highlight the Leverage Zone
                                box1: {
                                    type: 'box',
                                    xMin: 0, xMax: 50,
                                    yMin: 6.5, yMax: 9,
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderColor: 'rgba(16, 185, 129, 0.5)',
                                    borderWidth: 1,
                                    label: {
                                        content: 'LEVERAGE ZONE (Target)',
                                        enabled: true,
                                        position: 'start',
                                        color: 'green',
                                        font: { weight: 'bold' }
                                    }
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.raw.label + ': Risk ' + context.raw.x + ', Impact ' + context.raw.y;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- 2. STRATEGY C LOGIC ---
        let strategyActive = false;

        function toggleStrategy() {
            strategyActive = !strategyActive;
            const btn = document.getElementById('btn-strategy');
            const status = document.getElementById('strategy-status');
            const asiaBar = document.getElementById('bar-asia');
            const euBar = document.getElementById('bar-eu');
            const asiaVal = document.getElementById('kpi-asia');
            const euVal = document.getElementById('kpi-eu');

            if (strategyActive) {
                // ACTIVATE STRATEGY
                btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i> REVERT CHANGES';
                btn.classList.replace('bg-blue-600', 'bg-slate-600');
                btn.classList.replace('hover:bg-blue-500', 'hover:bg-slate-500');
                
                status.innerHTML = "ACTIVE";
                status.classList.replace('bg-red-500', 'bg-green-500');

                // Update KPIs
                asiaVal.innerHTML = "40%";
                euVal.innerHTML = "50%";
                asiaBar.style.width = "40%";
                euBar.style.width = "50%";

                // Update Chart
                marketChart.data.datasets[0].data = [40, 50, 10];
                marketChart.options.plugins.title.text = "Projected Geographic Share (Post-Strategy)";
                marketChart.update();

            } else {
                // REVERT
                btn.innerHTML = '<i class="fa-solid fa-rocket"></i> EXECUTE STRATEGY';
                btn.classList.replace('bg-slate-600', 'bg-blue-600');
                btn.classList.replace('hover:bg-slate-500', 'hover:bg-blue-500');

                status.innerHTML = "INACTIVE";
                status.classList.replace('bg-green-500', 'bg-red-500');

                // Update KPIs
                asiaVal.innerHTML = "63%";
                euVal.innerHTML = "27%";
                asiaBar.style.width = "63%";
                euBar.style.width = "27%";

                // Update Chart
                marketChart.data.datasets[0].data = [63, 27, 10];
                marketChart.options.plugins.title.text = "Current Geographic Share (%)";
                marketChart.update();
            }
        }

        // --- 3. SCENARIO SIMULATION LOGIC ---
        function updateSimulation() {
            // Get Checkbox States
            const s1_on = document.getElementById('check-s1').checked;
            const s2_on = document.getElementById('check-s2').checked;
            const s3_on = document.getElementById('check-s3').checked;

            // Get Slider Values
            const s1_val = parseInt(document.getElementById('slider-s1').value);
            const s2_val = parseInt(document.getElementById('slider-s2').value);
            const s3_val = parseInt(document.getElementById('slider-s3').value);

            // Update UI Labels
            document.getElementById('val-s1').innerText = s1_val + '%';
            document.getElementById('val-s2').innerText = s2_val + '%';
            document.getElementById('val-s3').innerText = s3_val + '%';

            // Calculate Individual Costs (If active)
            let risk_s1 = s1_on ? (ELEC_SPEND * (s1_val / 100)) : 0;
            let risk_s2 = s2_on ? (CHINA_SPEND * (s2_val / 100)) : 0;
            let risk_s3 = s3_on ? (ASIA_SPEND_TOTAL * (s3_val / 100)) : 0;

            const totalRisk = risk_s1 + risk_s2 + risk_s3;
            const totalCost = BASELINE_SPEND + totalRisk;

            // Update KPI Card
            document.getElementById('kpi-risk').innerText = "€" + (totalRisk / 1000000).toFixed(1) + "M";
            document.getElementById('total-sim-cost').innerText = "€" + (totalCost / 1000000).toFixed(1) + "M";
            
            // Update Risk Description
            let riskText = [];
            if (s1_on) riskText.push("S1");
            if (s2_on) riskText.push("S2");
            if (s3_on) riskText.push("S3");
            document.getElementById('risk-desc').innerText = riskText.length > 0 ? "Active Scenarios: " + riskText.join(" + ") : "Baseline: No active scenarios";

            // --- UPDATE CHART 1 (Stacked Bar) ---
            // Shows Composition of the Active Simulation
            scenarioChart.data.datasets[1].data = [0, risk_s1 / 1000000]; // S1 Price
            scenarioChart.data.datasets[2].data = [0, risk_s2 / 1000000]; // S2 Tariff
            scenarioChart.data.datasets[3].data = [0, risk_s3 / 1000000]; // S3 Logistics
            scenarioChart.update();

            // --- UPDATE CHART 2 (Escalation Ladder) ---
            // Shows "What-If" theoretical costs based on current slider settings
            // Logic: Calculate what S1, S2, S3 would cost individually based on current sliders
            const potential_s1 = BASELINE_SPEND + (ELEC_SPEND * (s1_val / 100));
            const potential_s2 = BASELINE_SPEND + (CHINA_SPEND * (s2_val / 100));
            const potential_s3 = BASELINE_SPEND + (ASIA_SPEND_TOTAL * (s3_val / 100));
            
            // Cumulative "Perfect Storm" (Sum of all potentials risks)
            const potential_storm = BASELINE_SPEND + (ELEC_SPEND * (s1_val / 100)) + (CHINA_SPEND * (s2_val / 100)) + (ASIA_SPEND_TOTAL * (s3_val / 100));

            // Data Array: [Baseline, S3, S2, S1, Perfect Storm] - Sorted by severity usually, but fixed order is better for stability
            // Using Millons
            const dataM = [
                BASELINE_SPEND / 1000000, 
                potential_s3 / 1000000, 
                potential_s2 / 1000000, 
                potential_s1 / 1000000, 
                potential_storm / 1000000
            ];

            escalationChart.data.datasets[0].data = dataM;
            escalationChart.update();
        }
    </script>
</body>
</html>